#! /usr/bin/env node
const argLen = process.argv.length;
if (argLen < 3 || argLen > 4){
  console.log("boilerplate takes in 1 file name and 1 optional flag");
  return;
}

const fs = require("fs");
const path = require("path");
const readline = require("readline");

/************************/
/*       Prompts        */
/************************/

let htmlFileName, flag;
if (argLen === 3 || process.argv[2][0] !== "-") {
  htmlFileName = process.argv[2];
  flag = process.argv[3];
} else if (process.argv[2][0] === "-"){
  htmlFileName = process.argv[3];
  flag = process.argv[2];
} else {
  console.log("Can only use --react or -r as flag")
  return;
}

let USE_REACT = false;
if (flag) {
  if (flag !== "--react" && flag !== "-r") {
    console.log("Can only use --react or -r as flag")
    return;
  } else {
    USE_REACT = true;
  }
}

htmlFileName = (path.extname(htmlFileName) !== ".html")
  ? htmlFileName + ".html"
  : htmlFileName;

const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout,
})

const dataForHTML = [htmlFileName];
const steps = [
  {
    type: "html",
    prompt: "Enter page title (press enter to skip):"
  },
  {
    type: "css",
    prompt: "Enter path to CSS file (press enter to skip):",
    content: "/* Generated by boilerplate */",
    ext: ".css"
  },
  {
    type: "js",
    prompt: "Enter path to JS file (press enter to skip):",
    content: "/* Generated by boilerplate */",
    ext: ".js"
  },
  {
    type: "jsx",
    prompt: "Enter path to JSX file (press enter to skip):",
    content: "/* Generated by boilerplate */",
    ext: ".jsx"
  }
];

// IIFE so we can use `async`
(async function(s) {
  // seems a bit hacky
  const idxToSkip = USE_REACT ? 2 : 3;

  for (let i = 0; i < s.length; i++) {
    if (i === idxToSkip) continue;

    const response = await promiseQuestion(s[i].prompt);
    const verifiedPath = (i !== 0)
      ? await promiseCheckFile(response, s[i].content, s[i].ext)
      : null

    // push response if verifiedPath is null
    dataForHTML.push(verifiedPath || response);
  }

  rl.close();
  createHTML(dataForHTML);

})(steps);

/************************/
/* Function definitions */
/************************/
function promiseCheckFile(filePath, content, ext) {
  // Try to open file; create dir and file if it doesn't exist (on error)
  return new Promise((resolve, reject) => {
    // Shortcut if user doesn't input path
    if (!filePath) {
      resolve(filePath);
      return;
    // If user inputs a file, append extension if not there
    } else if (!path.extname(filePath)) {
      filePath += ext;
    }

    fs.open(filePath, "r", (err, fd) => {
      if (err) {
        fs.mkdir(path.dirname(filePath), { recursive: true }, err => {
          if (err) reject(err);
          fs.writeFile(filePath, content, err => {
            if (err) reject(err);
          })
        })
      } else {
        fs.close(fd, err => {
          if (err) reject(err);
        })
      }
    })
    resolve(filePath)
  })
}

function promiseQuestion(question) {
  return new Promise((resolve, reject) => {
    rl.question(question + "\n", answer => {
      resolve(answer);
    })
  })
}

function createHTML(contentData) {
  const [htmlFile, title, css, js] = contentData;

  const cssBlock = (!css)
    ? "<style>\n      /* CSS here */\n    </style>"
    : `<link rel="stylesheet" type="text/css" href="${css}" />`;

  const typeContent = (USE_REACT && !js) ? "text/babel" : "application/javascript" ;
  const jsBlock = (!js)
    ? `<script type="${typeContent}">\n      /* JS(X) here */\n    </script>`
    : `<script type="${typeContent}" src="${js}"></script>`;

  const cdns = (USE_REACT && !js)
    ? "\n    " +
      `<script src="https://unpkg.com/react@16/umd/react.development.js" crossorigin></script>\n` +
      "    " +
      `<script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js" crossorigin></script>\n` +
      "    " +
      `<script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>`
    : ""

  const htmlString =
`<!DOCTYPE html>
<!-- Generated by boilerplate -->
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${title}</title>
    ${cssBlock}${cdns}
  </head>
  <body>
    ${jsBlock}
  </body>
</html>
`

  fs.writeFile(htmlFile, htmlString, err => {
    if (err) throw err;
    console.log(`Boilerplate ${htmlFile} written.`);
  })
}
