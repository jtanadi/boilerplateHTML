#! /usr/bin/env node
if (process.argv.length !== 3){
  console.log("boilerplate takes in 1 argument (file name)");
  return;
}

const fs = require("fs");
const path = require("path");
const readline = require("readline");
const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout,
})

/************************/
/*       Prompts        */
/************************/
const htmlFileName = (path.extname(process.argv[2]) === ".html")
  ? process.argv[2]
  : process.argv[2] + ".html";

const dataForHTML = [htmlFileName];
const steps = [
  {
    type: "html",
    prompt: "Enter page title (press enter to skip):"
  },
  {
    type: "css",
    prompt: "Enter path to CSS file (press enter to skip):",
    content: "/* Generated by boilerplate */",
    ext: ".css"
  },
  {
    type: "js",
    prompt: "Enter path to JS file (press enter to skip):",
    content: "/* Generated by boilerplate */",
    ext: ".js"
  }
];

// IIFE so we can use `async`
(async function(s) {
  for (let i = 0; i < s.length; i++) {
    const response = await promiseQuestion(s[i].prompt);
    const verifiedPath = (i !== 0)
      ? await promiseCheckFile(response, s[i].content, s[i].ext)
      : null

    // push response if verifiedPath is null
    dataForHTML.push(verifiedPath || response);

    if (i === s.length - 1) {
      rl.close();
      createHTML(dataForHTML);
    }
  }
})(steps);

/************************/
/* Function definitions */
/************************/
function promiseCheckFile(filePath, content, ext) {
  // Try to open file; create dir and file if it doesn't exist (on error)
  return new Promise((resolve, reject) => {
    // Shortcut if user doesn't input path
    if (!filePath) {
      resolve(filePath);
      return;
    // If user inputs a file, append extension if not there
    } else if (path.extname(filePath) !== ext) {
      filePath += ext;
    }

    fs.open(filePath, "r", (err, fd) => {
      if (err) {
        fs.mkdir(path.dirname(filePath), { recursive: true }, err => {
          if (err) reject(err);
          fs.writeFile(filePath, content, err => {
            if (err) reject(err);
          })
        })
      } else {
        fs.close(fd, err => {
          if (err) reject(err);
        })
      }
    })
    resolve(filePath)
  })
}

function promiseQuestion(question) {
  return new Promise((resolve, reject) => {
    rl.question(question + "\n", answer => {
      resolve(answer);
    })
  })
}

function createHTML(contentData) {
  const [htmlFile, title, css, js] = contentData;

  const cssBlock = (!css)
    ? "<style>\n      /* CSS here */\n    </style>"
    : `<link rel="stylesheet" type="text/css" href="${css}" />`

  const jsBlock = (!js)
    ? "<script>\n      /* JS here */\n    </script>"
    : `<script type="application/javascript" src="${js}"></script>`

  const htmlString =
`<!DOCTYPE html>
<!-- Generated by boilerplate -->
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${title}</title>
    ${cssBlock}
  </head>
  <body>
    ${jsBlock}
  </body>
</html>
`

  fs.writeFile(htmlFile, htmlString, err => {
    if (err) throw err;
    console.log(`Boilerplate ${htmlFile} written.`);
  })
}
